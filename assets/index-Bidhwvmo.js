(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const P=11970,Y=5426;var j;(function(n){n[n.SHORT=1]="SHORT",n[n.MEDIUM=10]="MEDIUM",n[n.LONG=15]="LONG",n[n.LOW=49]="LOW",n[n.SHORT_LOW=50]="SHORT_LOW",n[n.SHORT_LOWER=51]="SHORT_LOWER",n[n.LOWER=64]="LOWER",n[n.LOWEST=65]="LOWEST",n[n.DESCEND_SLOW=70]="DESCEND_SLOW",n[n.DESCEND_MED=71]="DESCEND_MED",n[n.DESCEND_FAST=72]="DESCEND_FAST",n[n.ASCEND_SLOW=82]="ASCEND_SLOW",n[n.ASCEND_MED=83]="ASCEND_MED",n[n.ASCEND_FAST=88]="ASCEND_FAST",n[n.REV_SLOWEST=94]="REV_SLOWEST",n[n.REV_SLOW=95]="REV_SLOW",n[n.REV_MED=96]="REV_MED",n[n.REV_FAST=97]="REV_FAST",n[n.REV_FASTER=98]="REV_FASTER",n[n.REV_FASTEST=99]="REV_FASTEST",n[n.RISE_FALL=106]="RISE_FALL",n[n.BUZZ=112]="BUZZ",n[n.RUMBLE5=119]="RUMBLE5",n[n.RUMBLE4=120]="RUMBLE4",n[n.RUMBLE3=121]="RUMBLE3",n[n.RUMBLE2=122]="RUMBLE2",n[n.RUMBLE1=123]="RUMBLE1",n[n.VERY_LONG=118]="VERY_LONG"})(j||(j={}));var w;(function(n){n.Left="left",n.Center="center",n.Right="right",n.Wheel="wheel"})(w||(w={}));const he=new Uint8Array([0,77]),ue=new Uint8Array([0,87]),fe=new Uint8Array([0,76]),pe=new Uint8Array([0,65]),we=new Uint8Array([0,82]);var T;(function(n){n.RGB="rgb"})(T||(T={}));function Q(n,e,t,r){const i=t+r.rowGap,s=t+r.columnGap;return[(a,l)=>!(r.rowGap>0&&(e+l)%i>=t||r.columnGap>0&&(n+a)%s>=t),a=>!(r.rowGap>0&&(e+a)%i>=t)]}function ye(n,e,t,r,i,s,c,o,a){const l=i*s;if(n.length!==l*t.length)throw new Error(`Incorrect buffer length ${n.length} expected ${l*t.length}`);if(e.length!==l*2+r)throw new Error(`Incorrect buffer length ${e.length} expected ${l*2+r}`);const d=E(n),h=E(e);switch(t){case T.RGB:for(let f=0;f<s;f++)if(o(f))for(let p=0;p<i;p++){if(!c(p,f))continue;const y=f*i+p,S=d.getUint8(y*3+0)>>3,u=d.getUint8(y*3+1)>>2,v=d.getUint8(y*3+2)>>3;h.setUint16(r+y*2,(S<<11)+(u<<5)+v,a!=="BE")}break;default:throw new Error(`Unknown BufferFormat: "${t}"`)}}function C(n){if(n<0||n>255)throw new TypeError("Expected a valid color RGB value 0 - 255")}function ge(n){C(n.red),C(n.green),C(n.blue)}function E(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}function me(n){if(n.length>255){const e=new Uint8Array(14),t=E(e);return t.setUint8(0,130),t.setUint8(1,255),t.setUint32(6,n.length,!1),e}else{const e=new Uint8Array(6),t=E(e);return t.setUint8(0,130),t.setUint8(1,128+n.length),e}}var g;(function(n){n.LoupedeckCtV1="loupedeck-ct-v1",n.LoupedeckCtV2="loupedeck-ct-v2",n.LoupedeckLive="loupedeck-live",n.LoupedeckLiveS="loupedeck-live-s",n.RazerStreamController="razer-stream-controller",n.RazerStreamControllerX="razer-stream-controller-x"})(g||(g={}));function Se(n){switch(n){case g.LoupedeckCtV1:case g.LoupedeckCtV2:return"Loupedeck CT";case g.LoupedeckLive:return"Loupedeck Live";case g.LoupedeckLiveS:return"Loupedeck Live S";case g.RazerStreamController:return"Razer Stream Controller";case g.RazerStreamControllerX:return"Razer Stream Controller X";default:return"Unknown Loupedeck Model"}}function Ee(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var W={exports:{}},Z;function be(){return Z||(Z=1,(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function i(a,l,d){this.fn=a,this.context=l,this.once=d||!1}function s(a,l,d,h,f){if(typeof d!="function")throw new TypeError("The listener must be a function");var p=new i(d,h||a,f),y=t?t+l:l;return a._events[y]?a._events[y].fn?a._events[y]=[a._events[y],p]:a._events[y].push(p):(a._events[y]=p,a._eventsCount++),a}function c(a,l){--a._eventsCount===0?a._events=new r:delete a._events[l]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],d,h;if(this._eventsCount===0)return l;for(h in d=this._events)e.call(d,h)&&l.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(d)):l},o.prototype.listeners=function(l){var d=t?t+l:l,h=this._events[d];if(!h)return[];if(h.fn)return[h.fn];for(var f=0,p=h.length,y=new Array(p);f<p;f++)y[f]=h[f].fn;return y},o.prototype.listenerCount=function(l){var d=t?t+l:l,h=this._events[d];return h?h.fn?1:h.length:0},o.prototype.emit=function(l,d,h,f,p,y){var S=t?t+l:l;if(!this._events[S])return!1;var u=this._events[S],v=arguments.length,D,m;if(u.fn){switch(u.once&&this.removeListener(l,u.fn,void 0,!0),v){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,d),!0;case 3:return u.fn.call(u.context,d,h),!0;case 4:return u.fn.call(u.context,d,h,f),!0;case 5:return u.fn.call(u.context,d,h,f,p),!0;case 6:return u.fn.call(u.context,d,h,f,p,y),!0}for(m=1,D=new Array(v-1);m<v;m++)D[m-1]=arguments[m];u.fn.apply(u.context,D)}else{var de=u.length,U;for(m=0;m<de;m++)switch(u[m].once&&this.removeListener(l,u[m].fn,void 0,!0),v){case 1:u[m].fn.call(u[m].context);break;case 2:u[m].fn.call(u[m].context,d);break;case 3:u[m].fn.call(u[m].context,d,h);break;case 4:u[m].fn.call(u[m].context,d,h,f);break;default:if(!D)for(U=1,D=new Array(v-1);U<v;U++)D[U-1]=arguments[U];u[m].fn.apply(u[m].context,D)}}return!0},o.prototype.on=function(l,d,h){return s(this,l,d,h,!1)},o.prototype.once=function(l,d,h){return s(this,l,d,h,!0)},o.prototype.removeListener=function(l,d,h,f){var p=t?t+l:l;if(!this._events[p])return this;if(!d)return c(this,p),this;var y=this._events[p];if(y.fn)y.fn===d&&(!f||y.once)&&(!h||y.context===h)&&c(this,p);else{for(var S=0,u=[],v=y.length;S<v;S++)(y[S].fn!==d||f&&!y[S].once||h&&y[S].context!==h)&&u.push(y[S]);u.length?this._events[p]=u.length===1?u[0]:u:c(this,p)}return this},o.prototype.removeAllListeners=function(l){var d;return l?(d=t?t+l:l,this._events[d]&&c(this,d)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(W)),W.exports}var xe=be();const F=Ee(xe);class oe extends Error{constructor(e){super(e),this.name="TimeoutError"}}class ve extends Error{constructor(e){super(),this.name="AbortError",this.message=e}}const J=n=>globalThis.DOMException===void 0?new ve(n):new DOMException(n),ee=n=>{const e=n.reason===void 0?J("This operation was aborted."):n.reason;return e instanceof Error?e:J(e)};function Re(n,e){const{milliseconds:t,fallback:r,message:i,customTimers:s={setTimeout,clearTimeout}}=e;let c,o;const l=new Promise((d,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:p}=e;p.aborted&&h(ee(p)),o=()=>{h(ee(p))},p.addEventListener("abort",o,{once:!0})}if(t===Number.POSITIVE_INFINITY){n.then(d,h);return}const f=new oe;c=s.setTimeout.call(void 0,()=>{if(r){try{d(r())}catch(p){h(p)}return}typeof n.cancel=="function"&&n.cancel(),i===!1?d():i instanceof Error?h(i):(f.message=i??`Promise timed out after ${t} milliseconds`,h(f))},t),(async()=>{try{d(await n)}catch(p){h(p)}})()}).finally(()=>{l.clear(),o&&e.signal&&e.signal.removeEventListener("abort",o)});return l.clear=()=>{s.clearTimeout.call(void 0,c),c=void 0},l}function Ie(n,e,t){let r=0,i=n.length;for(;i>0;){const s=Math.trunc(i/2);let c=r+s;t(n[c],e)<=0?(r=++c,i-=s+1):i=s}return r}class De{#e=[];enqueue(e,t){t={priority:0,...t};const r={priority:t.priority,id:t.id,run:e};if(this.size===0||this.#e[this.size-1].priority>=t.priority){this.#e.push(r);return}const i=Ie(this.#e,r,(s,c)=>c.priority-s.priority);this.#e.splice(i,0,r)}setPriority(e,t){const r=this.#e.findIndex(s=>s.id===e);if(r===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[i]=this.#e.splice(r,1);this.enqueue(i.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}}class Te extends F{#e;#i;#o=0;#c;#l;#d=0;#r;#h;#n;#f;#s=0;#a;#t;#u;#p=1n;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:De,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#i=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#c=e.intervalCap,this.#l=e.interval,this.#n=new e.queueClass,this.#f=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#u=e.throwOnTimeout===!0,this.#t=e.autoStart===!1}get#w(){return this.#i||this.#o<this.#c}get#b(){return this.#s<this.#a}#x(){this.#s--,this.#y(),this.emit("next")}#v(){this.#E(),this.#S(),this.#h=void 0}get#R(){const e=Date.now();if(this.#r===void 0){const t=this.#d-e;if(t<0)this.#o=this.#e?this.#s:0;else return this.#h===void 0&&(this.#h=setTimeout(()=>{this.#v()},t)),!0}return!1}#y(){if(this.#n.size===0)return this.#r&&clearInterval(this.#r),this.#r=void 0,this.emit("empty"),this.#s===0&&this.emit("idle"),!1;if(!this.#t){const e=!this.#R;if(this.#w&&this.#b){const t=this.#n.dequeue();return t?(this.emit("active"),t(),e&&this.#S(),!0):!1}}return!1}#S(){this.#i||this.#r!==void 0||(this.#r=setInterval(()=>{this.#E()},this.#l),this.#d=Date.now()+this.#l)}#E(){this.#o===0&&this.#s===0&&this.#r&&(clearInterval(this.#r),this.#r=void 0),this.#o=this.#e?this.#s:0,this.#g()}#g(){for(;this.#y(););}get concurrency(){return this.#a}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#a=e,this.#g()}async#I(e){return new Promise((t,r)=>{e.addEventListener("abort",()=>{r(e.reason)},{once:!0})})}setPriority(e,t){this.#n.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#p++).toString(),t={timeout:this.timeout,throwOnTimeout:this.#u,...t},new Promise((r,i)=>{this.#n.enqueue(async()=>{this.#s++;try{t.signal?.throwIfAborted(),this.#o++;let s=e({signal:t.signal});t.timeout&&(s=Re(Promise.resolve(s),{milliseconds:t.timeout})),t.signal&&(s=Promise.race([s,this.#I(t.signal)]));const c=await s;r(c),this.emit("completed",c)}catch(s){if(s instanceof oe&&!t.throwOnTimeout){r();return}i(s),this.emit("error",s)}finally{this.#x()}},t),this.emit("add"),this.#y()})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this.#t?(this.#t=!1,this.#g(),this):this}pause(){this.#t=!0}clear(){this.#n=new this.#f}async onEmpty(){this.#n.size!==0&&await this.#m("empty")}async onSizeLessThan(e){this.#n.size<e||await this.#m("next",()=>this.#n.size<e)}async onIdle(){this.#s===0&&this.#n.size===0||await this.#m("idle")}async#m(e,t){return new Promise(r=>{const i=()=>{t&&!t()||(this.off(e,i),r())};this.on(e,i)})}get size(){return this.#n.size}sizeBy(e){return this.#n.filter(e).length}get pending(){return this.#s}get isPaused(){return this.#t}}var b;(function(n){n[n.SetColour=2]="SetColour",n[n.GetSerialNumber=3]="GetSerialNumber",n[n.GetVersion=7]="GetVersion",n[n.SetBrightness=9]="SetBrightness",n[n.RefreshDisplay=15]="RefreshDisplay",n[n.DrawFramebuffer=16]="DrawFramebuffer",n[n.SetVibration=27]="SetVibration"})(b||(b={}));class _ extends F{#e={};#i;options;modelSpec;get controls(){return this.modelSpec.controls}get displayMain(){return this.modelSpec.displayMain}get displayLeftStrip(){return this.modelSpec.displayLeftStrip}get displayRightStrip(){return this.modelSpec.displayRightStrip}get displayWheel(){return this.modelSpec.displayWheel}#o={};#c=0;#l;constructor(e,t,r){super(),this.#i=e,this.options={...t},this.modelSpec=r,this.options.skipWaitForAcks||(this.#l=new Te({concurrency:1})),this.#i.on("error",i=>{this.#r(),this.emit("error",i)}),this.#i.on("disconnect",()=>{this.#r(),this.emit("error",new Error("Connection lost"))}),this.#i.on("message",this.#h.bind(this))}get modelId(){return this.modelSpec.modelId}get modelName(){return Se(this.modelSpec.modelId)}get lcdKeySize(){return this.modelSpec.lcdKeySize}#d(e){switch(e){case w.Center:return this.displayMain;case w.Left:return this.displayLeftStrip;case w.Right:return this.displayRightStrip;case w.Wheel:return this.displayWheel;default:return}}async blankDevice(e=!0,t=!0){await this.#a(async()=>{if(e)for(const r of Object.values(w)){const i=this.#d(r);if(i){const{encoded:s,encodedDisplay:c}=this.createBufferWithHeader(r,i.width+i.xPadding*2,i.height+i.yPadding*2,0,0);await this.#t(b.DrawFramebuffer,s,!0),this.modelSpec.framebufferFlush&&await this.#t(b.RefreshDisplay,c,!0)}}if(t){const r=this.controls.filter(i=>i.type==="button"&&i.feedbackType==="rgb");if(r.length>0){const i=new Uint8Array(4*r.length),s=E(i);for(let c=0;c<r.length;c++)s.setUint8(c*4,r[c].encodedIndex);await this.#t(b.SetColour,i,!0)}}},!1)}#r(){setTimeout(()=>{for(const e of Object.values(this.#o))e.reject(new Error("Connection closed"))},0)}async close(){this.#r(),await this.#i.close()}createBufferWithHeader(e,t,r,i,s){if(!this.modelSpec.splitTopDisplays&&!(e===w.Left||e===w.Wheel))if(e===w.Center)i+=this.displayLeftStrip?.width??0;else if(e===w.Right)i+=(this.displayLeftStrip?.width??0)+(this.displayMain.width+this.displayMain.xPadding*2);else throw new Error("Unknown DisplayId");const c=10,o=t*r,a=new Uint8Array(o*2+c),l=E(a);let d=he;if(e===w.Wheel)d=ue;else if(this.modelSpec.splitTopDisplays)switch(e){case w.Center:d=pe;break;case w.Left:d=fe;break;case w.Right:d=we;break;default:throw new Error("Unknown DisplayId")}return a.set(d,0),l.setUint16(2,i,!1),l.setUint16(4,s,!1),l.setUint16(6,t,!1),l.setUint16(8,r,!1),{encoded:a,padding:c,encodedDisplay:d}}async drawBuffer(e,t,r,i,s,c,o){const a=this.#d(e);if(!a)throw new Error("Invalid DisplayId");if(i<0||i>a.width)throw new Error("Image width is not valid");if(s<0||s>a.height)throw new Error("Image width is not valid");if(c<0||c+i>a.width)throw new Error("x is not valid");if(o<0||o+s>a.height)throw new Error("x is not valid");const{encoded:l,padding:d,encodedDisplay:h}=this.createBufferWithHeader(e,i,s,c+a.xPadding,o+a.yPadding),[f,p]=Q(c,o,this.lcdKeySize,a);ye(t,l,r,d,i,s,f,p,a.endianness),await this.#a(async()=>{await this.#t(b.DrawFramebuffer,l,!0),this.modelSpec.framebufferFlush&&await this.#t(b.RefreshDisplay,h,!0)},!1)}async drawKeyBuffer(e,t,r){const i=this.controls.find(s=>s.type==="button"&&s.id===e);if(!i)throw new Error("Invalid button id");if(i.feedbackType!=="lcd"||!i.lcdPosition)throw new Error("Control is not an LCD button");return this.drawBuffer(i.lcdPosition.display,t,r,i.lcdPosition.size,i.lcdPosition.size,i.lcdPosition.x,i.lcdPosition.y)}async drawSolidColour(e,t,r,i,s,c){const o=this.#d(e);if(!o)throw new Error("Invalid DisplayId");if(r<0||r>o.width)throw new Error("Image width is not valid");if(i<0||i>o.height)throw new Error("Image height is not valid");if(s<0||s+r>o.width)throw new Error("x is not valid");if(c<0||c+i>o.height)throw new Error("y is not valid");ge(t);const a=((Math.round(t.red)>>3&31)<<11)+((Math.round(t.green)>>2&63)<<5)+(Math.round(t.blue)>>3&31),[l,d]=Q(s,c,this.lcdKeySize,o),{encoded:h,padding:f,encodedDisplay:p}=this.createBufferWithHeader(e,r,i,s+o.xPadding,c),y=E(h);for(let S=0;S<i;S++)if(d(S)){for(let u=0;u<r;u++)if(l(u,S)){const v=S*r+u;y.setUint16(v*2+f,a,o.endianness!=="BE")}}await this.#a(async()=>{await this.#t(b.DrawFramebuffer,h,!0),this.modelSpec.framebufferFlush&&await this.#t(b.RefreshDisplay,p,!0)},!1)}async getFirmwareVersion(){const e=await this.#u(b.GetVersion,void 0),t=E(e);return`${t.getUint8(0)}.${t.getUint8(1)}.${t.getUint8(2)}`}async getSerialNumber(){const e=await this.#u(b.GetSerialNumber,void 0);return new TextDecoder().decode(e).trim()}#h(e){try{const t=E(e);if(t.getUint8(2)+2!==e.length)return;const i=t.getUint8(3),s=t.getUint8(4);if(s===0)switch(i){case 0:this.#n(e.subarray(5));break;case 1:this.#f(e.subarray(5));break;case 77:this.onTouch("touchmove",e.subarray(5));break;case 109:this.onTouch("touchend",e.subarray(5));break;case 82:this.onWheelTouch("touchmove",e.subarray(5));break;case 114:this.onWheelTouch("touchend",e.subarray(5));break;default:console.warn("unhandled incoming message",e);break}else{const c=this.#o[s];c&&(c.resolve(e.subarray(5)),delete this.#o[s])}}catch(t){console.error("Unhandled error in serial message handler:",t)}}#n(e){const t=E(e),r=t.getUint8(0),i=this.controls.find(s=>(s.type==="button"||s.type==="encoder")&&s.encodedIndex===r);if(i){const s=t.getUint8(1)===0?"down":"up";this.emit(s,i)}}#f(e){const t=E(e),r=t.getUint8(0),i=r===0?this.controls.find(s=>s.type==="wheel"):this.controls.find(s=>s.type==="encoder"&&s.encodedIndex===r);if(i){const s=t.getInt8(1);this.emit("rotate",i,s)}}#s(e,t,r,i,s,c){const o={x:t,y:r,id:i,target:{screen:s,control:c}};e==="touchend"?delete this.#e[o.id]:(this.#e[o.id]||(e="touchstart"),this.#e[o.id]=o),this.emit(e,{touches:Object.values(this.#e),changedTouches:[o]})}onTouch(e,t){const r=E(t);let i=r.getUint16(1,!1),s=r.getUint16(3,!1);const c=r.getUint8(5),o=this.displayMain.width+this.displayMain.xPadding*2,a=this.displayLeftStrip?.width??0;let l=w.Center;const d=(this.displayLeftStrip?.width??0)+o;this.displayLeftStrip&&i<a?l=w.Left:this.displayRightStrip&&i>=d?(l=w.Right,i-=d):(i-=a+this.displayMain.xPadding,s-=this.displayMain.yPadding);const h=this.modelSpec.controls.find(f=>{switch(l){case w.Left:return f.type==="lcd-segment"&&f.id==="left";case w.Right:return f.type==="lcd-segment"&&f.id==="right";case w.Center:return!(f.type!=="button"||f.feedbackType!=="lcd"||!f.lcdPosition||i<f.lcdPosition.x||i>=f.lcdPosition.x+f.lcdPosition.size||s<f.lcdPosition.y||s>=f.lcdPosition.y+f.lcdPosition.size);default:return!1}});this.#s(e,i,s,c,l,h)}onWheelTouch(e,t){const r=E(t),i=r.getUint16(1,!1),s=r.getUint16(3,!1),c=r.getUint8(5),o=w.Wheel,a=this.modelSpec.controls.find(l=>l.type==="wheel");this.#s(e,i,s,c,o,a)}async setBrightness(e){const r=Math.max(0,Math.min(10,Math.round(e*10)));return this.#t(b.SetBrightness,new Uint8Array([r]))}async setButtonColor(...e){if(e.length===0)return;const t={};for(const s of this.controls)s.type==="button"&&s.feedbackType==="rgb"&&(t[s.id]=s.encodedIndex);const r=new Uint8Array(4*e.length),i=E(r);for(let s=0;s<e.length;s++){const c=e[s],o=s*4,a=t[c.id];if(a===void 0)throw new TypeError("Expected a valid button id");C(c.red),C(c.green),C(c.blue),i.setUint8(0+o,a),i.setUint8(1+o,c.red),i.setUint8(2+o,c.green),i.setUint8(3+o,c.blue)}return this.#t(b.SetColour,r)}async vibrate(e){if(!e)throw new Error("Invalid vibrate pattern");return this.#t(b.SetVibration,new Uint8Array([e]))}async#a(e,t){return this.#l&&!t?this.#l.add(e,{throwOnTimeout:!0}):e()}async#t(e,t,r=!1){return this.#a(async()=>{const i=await this.#p(e,t);this.options.skipWaitForAcks||await this.#w(i)},r)}async#u(e,t,r=!1){return this.#a(async()=>{const i=await this.#p(e,t);return this.#w(i)},r)}async#p(e,t){if(!this.#i.isReady())throw new Error("Not connected!");this.#c=(this.#c+1)%256,this.#c===0&&this.#c++;const r=new Uint8Array(3+(t?.length??0)),i=E(r);return i.setUint8(0,r.length>=255?255:r.length),i.setUint8(1,e),i.setUint8(2,this.#c),t&&t.length&&r.set(t,3),await this.#i.send(r),this.#c}async#w(e){if(this.#o[e])throw new Error("Transaction handler already defined");if(!this.#i.isReady())throw new Error("Connection is not open");const t={resolve:()=>null,reject:()=>null},r=new Promise((i,s)=>{t.resolve=i,t.reject=s});return this.#o[e]=t,r}}function O(n){return Object.freeze(n.map(e=>Object.freeze(e)))}function q(n){const e=[];for(let t=0;t<8;t++)e.push({id:`button-${t+1}`,type:"button",row:3,column:t,encodedIndex:n+t,feedbackType:"rgb"});return e}function te(n,e){const t=[];for(let r=0;r<3;r++)t.push({id:`encoder-${r}-${e}`,type:"encoder",row:r,column:e,encodedIndex:n+r});return t}function H(n){return[...te(n,0),...te(n+3,7)]}function K(n,e){return[{id:"left",type:"lcd-segment",row:0,column:n,rowSpan:3,columnSpan:1},{id:"right",type:"lcd-segment",row:0,column:e,rowSpan:3,columnSpan:1}]}function A(n,e){const t=[];for(let r=0;r<e.rows;r++)for(let i=0;i<e.columns;i++){const s=r*e.columns+i,c=r,o=i+e.colOffset;t.push({id:`button-${c}-${o}`,type:"button",row:c,column:o,encodedIndex:e.startEncodedIndex!==null?e.startEncodedIndex+s:0,feedbackType:"lcd",lcdPosition:{display:w.Center,size:n.lcdKeySize,x:i*(n.lcdKeySize+n.displayMain.columnGap),y:r*(n.lcdKeySize+n.displayMain.rowGap)}})}return t}const Ce={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},Le={width:350,height:260,xPadding:5,yPadding:5,columnGap:10,rowGap:10},_e={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},$={controls:[],displayMain:Le,displayLeftStrip:Ce,displayRightStrip:_e,modelId:g.LoupedeckLive,lcdKeySize:80};$.controls.push(...q(7),...H(1),...K(1,6),...A($,{rows:3,columns:4,colOffset:2,startEncodedIndex:null}));O($.controls);class Oe extends _{constructor(e,t){super(e,t,$)}}const Ue={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},Be={width:350,height:260,xPadding:5,yPadding:5,columnGap:10,rowGap:10},Me={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},G={controls:[],displayMain:Be,displayLeftStrip:Ue,displayRightStrip:Me,modelId:g.RazerStreamController,lcdKeySize:80};G.controls.push(...q(7),...H(1),...K(1,6),...A(G,{rows:3,columns:4,colOffset:2,startEncodedIndex:null}));O(G.controls);class Ae extends _{constructor(e,t){super(e,t,G)}}const Pe={width:444,height:260,xPadding:18,yPadding:5,columnGap:10,rowGap:10},L={controls:[],displayMain:Pe,displayLeftStrip:void 0,displayRightStrip:void 0,modelId:g.LoupedeckLiveS,lcdKeySize:80};L.controls.push({type:"encoder",id:"encoder-0-0",row:0,column:0,encodedIndex:1},{type:"encoder",id:"encoder-1-0",row:1,column:0,encodedIndex:2},{type:"button",id:"button-2-0",row:2,column:0,encodedIndex:7,feedbackType:"rgb"});for(let n=0;n<3;n++)L.controls.push({type:"button",id:`button-${n}-6`,row:n,column:6,encodedIndex:8+n,feedbackType:"rgb"});L.controls.push(...A(L,{rows:3,columns:5,colOffset:1,startEncodedIndex:null}));O(L.controls);class $e extends _{constructor(e,t){super(e,t,L)}}const Ge={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},Ne={width:350,height:260,xPadding:5,yPadding:5,columnGap:10,rowGap:10},We={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},ke={width:240,height:240,xPadding:0,yPadding:0,columnGap:0,rowGap:0,endianness:"BE"},M={controls:[],displayMain:Ne,displayLeftStrip:Ge,displayRightStrip:We,displayWheel:ke,modelId:g.LoupedeckCtV2,lcdKeySize:80};M.controls.push(...q(7),...H(1),...K(1,6),...A(M,{rows:3,columns:4,colOffset:2,startEncodedIndex:null}),{type:"button",id:"button-home",row:4,column:0,encodedIndex:8,feedbackType:"rgb"},{type:"button",id:"button-undo",row:5,column:0,encodedIndex:9,feedbackType:"rgb"},{type:"button",id:"button-keyboard",row:6,column:0,encodedIndex:10,feedbackType:"rgb"},{type:"button",id:"button-return",row:4,column:1,encodedIndex:11,feedbackType:"rgb"},{type:"button",id:"button-save",row:5,column:1,encodedIndex:12,feedbackType:"rgb"},{type:"button",id:"button-fn-left",row:6,column:1,encodedIndex:13,feedbackType:"rgb"},{type:"button",id:"button-up",row:4,column:6,encodedIndex:14,feedbackType:"rgb"},{type:"button",id:"button-left",row:5,column:6,encodedIndex:15,feedbackType:"rgb"},{type:"button",id:"button-fn-right",row:6,column:6,encodedIndex:16,feedbackType:"rgb"},{type:"button",id:"button-down",row:4,column:7,encodedIndex:17,feedbackType:"rgb"},{type:"button",id:"button-right",row:5,column:7,encodedIndex:18,feedbackType:"rgb"},{type:"button",id:"button-blank",row:6,column:7,encodedIndex:19,feedbackType:"rgb"},{type:"wheel",id:"wheel",row:4,column:2,rowSpan:3,columnSpan:4});O(M.controls);class ze extends _{constructor(e,t){super(e,t,M)}}const Fe={width:470,height:270,xPadding:5,yPadding:0,columnGap:20,rowGap:18},N={controls:[],displayMain:Fe,displayLeftStrip:void 0,displayRightStrip:void 0,modelId:g.RazerStreamControllerX,lcdKeySize:78};N.controls.push(...A(N,{rows:3,columns:5,colOffset:0,startEncodedIndex:27}));O(N.controls);class qe extends _{constructor(e,t){super(e,t,N)}onTouch(e,t){}}const ce={...M,splitTopDisplays:!0,modelId:g.LoupedeckCtV1,framebufferFlush:!0};O(ce.controls);class He extends _{constructor(e,t){super(e,t,ce)}}const X=[{id:g.LoupedeckCtV1,vendorId:P,productId:3,class:He},{id:g.LoupedeckCtV2,vendorId:P,productId:7,class:ze},{id:g.LoupedeckLive,vendorId:P,productId:4,class:Oe},{id:g.LoupedeckLiveS,vendorId:P,productId:6,class:$e},{id:g.RazerStreamController,vendorId:Y,productId:3334,class:Ae},{id:g.RazerStreamControllerX,vendorId:Y,productId:3337,class:qe}],Ke=new TextEncoder().encode(`GET /index.html
HTTP/1.1
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Key: 123abc

`),Xe="HTTP/1.1";class Ve extends F{}class V extends Ve{connection;reader;writer;isOpen;constructor(e,t,r){super(),this.connection=e,this.reader=t,this.writer=r,this.isOpen=!0,this.connection.addEventListener("error",i=>{this.emit("error",i)}),this.connection.addEventListener("connect",()=>{console.log("connect"),this.isOpen=!0;try{this.openReaderWriter()}catch(i){this.emit("error",i)}}),this.connection.addEventListener("disconnect",()=>{console.log("disconnect"),this.isOpen=!1,this.closeReaderWriter(),this.emit("disconnect")}),this.startReadLoop(this.reader)}startReadLoop(e){Promise.resolve().then(async()=>{const t=new Ye({delimiter:130});for(;;){const{value:r,done:i}=await e.read();if(r){const s=t.transform(r);for(const c of s)this.emit("message",c)}if(i){e.releaseLock();break}}}).catch(t=>{this.emit("error",t)})}closeReaderWriter(){this.writer&&(this.writer.close().catch(()=>null),delete this.writer)}openReaderWriter(){if(this.closeReaderWriter(),!this.connection)throw new Error("SerialPort is closed");if(!this.connection.writable)throw new Error("SerialPort is not writable");if(!this.connection.readable)throw new Error("SerialPort is not readable");this.writer=this.connection.writable.getWriter(),this.reader=this.connection.readable.getReader(),this.startReadLoop(this.reader)}static async open(e){let t,r;try{if(await e.open({baudRate:256e3}),!e.writable)throw new Error("SerialPort is not writable");if(!e.readable)throw new Error("SerialPort is not readable");r=e.writable.getWriter(),t=e.readable.getReader();let i=!1;const s=r,[c]=await Promise.all([t.read().then(a=>(i=!0,a)),new Promise((a,l)=>{setTimeout(()=>{l(new Error("Timed out"))},5e3);const d=()=>{i?a():s.write(Ke).then(()=>{setTimeout(d,10)}).catch(h=>{l(h instanceof Error?h:new Error(String(h)))})};d()})]).catch(a=>{throw i=!0,t?.cancel("Aborted").catch(()=>null),a});if(!c.value)throw new Error("No handshake response");const o=new TextDecoder().decode(c.value);if(!o.startsWith(Xe))throw new Error(`Invalid handshake response: ${o}`);return new V(e,t,r)}catch(i){throw e.close().catch(()=>null),t?.cancel("Aborted")?.catch(()=>null),r?.abort("Aborted")?.catch(()=>null),i}}async close(){this.writer&&(this.writer.close().catch(()=>null),delete this.writer),this.connection&&(await this.connection.close().catch(()=>null),delete this.connection)}isReady(){return this.connection!==void 0&&this.isOpen}async send(e,t=!1){if(!this.connection||!this.writer)throw new Error("Not connected!");if(!t){const r=me(e);await this.writer.write(r)}await this.writer.write(e)}}class Ye{buffer=new Uint8Array(0);start=!0;opts;constructor(e={}){const{delimiter:t=170,packetOverhead:r=2,lengthOffset:i=1,maxLen:s=255}=e;this.opts={delimiter:t,packetOverhead:r,lengthOffset:i,maxLen:s}}transform(e){const t=[];for(let r=0;r<e.length;r++){const i=e[r];if(i===this.opts.delimiter&&(this.start=!0),this.start===!0){const s=this.buffer;this.buffer=new Uint8Array(s.length+1);const c=E(this.buffer);if(this.buffer.set(s,0),this.buffer[this.buffer.length-1]=i,this.buffer.length>=this.opts.lengthOffset+1){const o=c.getUint8(this.opts.lengthOffset);(this.buffer.length==o+this.opts.packetOverhead||o>this.opts.maxLen)&&(t.push(this.buffer),this.buffer=new Uint8Array(0),this.start=!1)}}}return t}}const je=X.map(n=>({usbProductId:n.productId,usbVendorId:n.vendorId}));async function Qe(n){const e=await navigator.serial.requestPort({filters:je});return ae(e)}async function Ze(n){const e=await navigator.serial.getPorts();if(e.length===0)return[];const t=new Set;for(const s of X)t.add(`${s.vendorId}-${s.productId}`);const r=e.filter(s=>{const c=s.getInfo();return t.has(`${c.usbVendorId}-${c.usbProductId}`)});return(await Promise.all(r.map(async s=>ae(s).catch(c=>null)))).filter(s=>!!s)}async function ae(n,e){const t=n.getInfo(),r=X.find(o=>o.productId===t.usbProductId&&o.vendorId===t.usbVendorId);if(!r)throw new Error("Stream Deck is of unexpected type.");const i=await V.open(n),s={};return new r.class(i,s||{})}const Je={red:255,green:0,blue:0},et={red:0,green:0,blue:0},ne=new Uint8Array(6400*3),z=new Uint8Array(6400*3);for(let n=0;n<6400;n++)z.set([255,0,0],n*3);class le{pressed=[];touchBoxes=new Set;touchingLeft=!1;touchingRight=!1;async start(e){await e.blankDevice(!0,!1)}async stop(e){await e.blankDevice(!0,!1)}async controlDown(e,t){this.pressed.indexOf(t.id)===-1&&(this.pressed.push(t.id),e.modelId===g.RazerStreamControllerX?await e.drawKeyBuffer(t.id,z,T.RGB):await e.setButtonColor({id:t.id,...Je}))}async controlUp(e,t){const r=this.pressed.indexOf(t.id);r!==-1&&(this.pressed.splice(r,1),e.modelId===g.RazerStreamControllerX?await e.drawKeyBuffer(t.id,ne,T.RGB):await e.setButtonColor({id:t.id,...et}))}async controlRotate(e,t,r){}async touchStart(e,t){return this.touchMove(e,t)}async touchMove(e,t){const r=[],i=new Set;let s=0,c=0;for(const o of t.touches)if(o.target.screen===w.Center&&o.target.control!==void 0)i.add(o.target.control.id),this.touchBoxes.has(o.target.control.id)||(this.touchBoxes.add(o.target.control.id),r.push(e.drawKeyBuffer(o.target.control.id,z,T.RGB)));else if(o.target.screen===w.Left&&e.displayLeftStrip){const a=o.y/e.displayLeftStrip.height;s=Math.max(s,a)}else if(o.target.screen===w.Right&&e.displayRightStrip){const a=o.y/e.displayRightStrip.height;c=Math.max(c,a)}for(const o of this.touchBoxes)i.has(o)||(this.touchBoxes.delete(o),r.push(e.drawKeyBuffer(o,ne,T.RGB)));e.displayLeftStrip&&(s>0||this.touchingLeft)&&(this.touchingLeft=s>0,r.push(e.drawSolidColour(w.Left,{red:Math.round(255*s),green:0,blue:0},e.displayLeftStrip.width,e.displayLeftStrip.height,0,0))),e.displayRightStrip&&(c>0||this.touchingRight)&&(this.touchingRight=c>0,r.push(e.drawSolidColour(w.Right,{red:Math.round(255*c),green:0,blue:0},e.displayRightStrip.width,e.displayRightStrip.height,0,0))),await Promise.allSettled(r)}async touchEnd(e,t){return this.touchMove(e,t)}}function k(n,e){return n=Math.ceil(n),e=Math.floor(e),Math.floor(Math.random()*(e-n+1))+n}class tt{interval;running;async start(e){if(!this.interval){const t=async()=>{if(!this.running){const r={red:k(0,255),green:k(0,255),blue:k(0,255)};console.log("Filling with rgb(%d, %d, %d)",r.red,r.green,r.blue),this.running=Promise.all([e.drawSolidColour(w.Center,r,e.displayMain.width,e.displayMain.height,0,0),e.displayLeftStrip?e.drawSolidColour(w.Left,r,e.displayLeftStrip.width,e.displayLeftStrip.height,0,0):void 0,e.displayRightStrip?e.drawSolidColour(w.Right,r,e.displayRightStrip.width,e.displayRightStrip.height,0,0):void 0]);try{await this.running}finally{this.running=void 0}}};this.interval=window.setInterval(()=>{t().catch(r=>console.log(r))},1e3/5)}}async stop(e){this.interval&&(window.clearInterval(this.interval),this.interval=void 0),await this.running,await e.blankDevice(!0,!0)}async controlDown(e,t){}async controlUp(e,t){}async controlRotate(e,t,r){}async touchStart(e,t){}async touchMove(e,t){}async touchEnd(e,t){}}function R(n){const e=document.getElementById("log");e&&(e.textContent=`${n}
${e.textContent??""}`)}const B=document.getElementById("demo-select"),re=document.getElementById("consent-button");let x=null,I=new le;async function ie(){if(B){switch(console.log(`Selected demo: ${B.value}`),x&&await I.stop(x),B.value){case"rapid-fill":I=new tt;break;case"fill-when-pressed":default:I=new le;break}x&&await I.start(x)}}async function se(n){R("Device opened"),R(`Serial: ${await n.getSerialNumber()} Firmware: ${await n.getFirmwareVersion()}`),n.on("error",e=>{R(`Error: ${e}`)}),n.on("down",e=>{R(`${e.type}-${e.row}-${e.column} down`),I.controlDown(n,e).catch(console.error)}),n.on("up",e=>{R(`${e.type}-${e.row}-${e.column} up`),I.controlUp(n,e).catch(console.error)}),n.on("rotate",(e,t)=>{R(`${e.type}-${e.row}-${e.column} rotate ${t}`),I.controlRotate(n,e,t).catch(console.error)}),n.on("touchstart",e=>{R(`Touch start ${JSON.stringify(e)}`),I.touchStart(n,e).catch(console.error)}),n.on("touchmove",e=>{R(`Touch move ${JSON.stringify(e)}`),I.touchMove(n,e).catch(console.error)}),n.on("touchend",e=>{R(`Touch end ${JSON.stringify(e)}`),I.touchEnd(n,e).catch(console.error)}),await I.start(n),await n.setBrightness(70)}if(re){const n=async()=>{const r=await Ze();r.length>0&&(x=r[0],se(x).catch(console.error)),console.log(r)};window.addEventListener("load",()=>{n().catch(r=>console.error(r))});const e=document.getElementById("brightness-range");e&&e.addEventListener("input",r=>{const i=e.value;x&&x.setBrightness(i/100).catch(console.error)}),B&&(B.addEventListener("input",()=>{ie().catch(console.error)}),ie().catch(console.error));const t=async()=>{x&&(R("Closing device"),I.stop(x).catch(console.error),await x.close(),x=null);try{x=await Qe()}catch(r){R(`No device access granted: ${r}`);return}se(x).catch(console.error)};re.addEventListener("click",()=>{t().catch(r=>console.error(r))}),R("Page loaded")}
