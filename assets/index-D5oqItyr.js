(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const M=11970,k=5426;var v;(function(t){t.Button="button",t.Rotary="rotary"})(v||(v={}));var q;(function(t){t[t.SHORT=1]="SHORT",t[t.MEDIUM=10]="MEDIUM",t[t.LONG=15]="LONG",t[t.LOW=49]="LOW",t[t.SHORT_LOW=50]="SHORT_LOW",t[t.SHORT_LOWER=51]="SHORT_LOWER",t[t.LOWER=64]="LOWER",t[t.LOWEST=65]="LOWEST",t[t.DESCEND_SLOW=70]="DESCEND_SLOW",t[t.DESCEND_MED=71]="DESCEND_MED",t[t.DESCEND_FAST=72]="DESCEND_FAST",t[t.ASCEND_SLOW=82]="ASCEND_SLOW",t[t.ASCEND_MED=83]="ASCEND_MED",t[t.ASCEND_FAST=88]="ASCEND_FAST",t[t.REV_SLOWEST=94]="REV_SLOWEST",t[t.REV_SLOW=95]="REV_SLOW",t[t.REV_MED=96]="REV_MED",t[t.REV_FAST=97]="REV_FAST",t[t.REV_FASTER=98]="REV_FASTER",t[t.REV_FASTEST=99]="REV_FASTEST",t[t.RISE_FALL=106]="RISE_FALL",t[t.BUZZ=112]="BUZZ",t[t.RUMBLE5=119]="RUMBLE5",t[t.RUMBLE4=120]="RUMBLE4",t[t.RUMBLE3=121]="RUMBLE3",t[t.RUMBLE2=122]="RUMBLE2",t[t.RUMBLE1=123]="RUMBLE1",t[t.VERY_LONG=118]="VERY_LONG"})(q||(q={}));var w;(function(t){t.Left="left",t.Center="center",t.Right="right",t.Wheel="wheel"})(w||(w={}));const oe=new Uint8Array([0,77]),ae=new Uint8Array([0,87]),ce=new Uint8Array([0,76]),le=new Uint8Array([0,65]),he=new Uint8Array([0,82]);var _;(function(t){t.RGB="rgb"})(_||(_={}));var E;(function(t){t.LoupedeckCt="loupedeck-ct",t.LoupedeckCtV1="loupedeck-ct-v1",t.LoupedeckLive="loupedeck-live",t.LoupedeckLiveS="loupedeck-live-s",t.RazerStreamController="razer-stream-controller",t.RazerStreamControllerX="razer-stream-controller-x"})(E||(E={}));function de(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var A={exports:{}},H;function ue(){return H||(H=1,(function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1));function i(c,l,h){this.fn=c,this.context=l,this.once=h||!1}function s(c,l,h,d,y){if(typeof h!="function")throw new TypeError("The listener must be a function");var f=new i(h,d||c,y),p=n?n+l:l;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],f]:c._events[p].push(f):(c._events[p]=f,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new r:delete c._events[l]}function a(){this._events=new r,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],h,d;if(this._eventsCount===0)return l;for(d in h=this._events)e.call(h,d)&&l.push(n?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(h)):l},a.prototype.listeners=function(l){var h=n?n+l:l,d=this._events[h];if(!d)return[];if(d.fn)return[d.fn];for(var y=0,f=d.length,p=new Array(f);y<f;y++)p[y]=d[y].fn;return p},a.prototype.listenerCount=function(l){var h=n?n+l:l,d=this._events[h];return d?d.fn?1:d.length:0},a.prototype.emit=function(l,h,d,y,f,p){var m=n?n+l:l;if(!this._events[m])return!1;var u=this._events[m],D=arguments.length,I,g;if(u.fn){switch(u.once&&this.removeListener(l,u.fn,void 0,!0),D){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,h),!0;case 3:return u.fn.call(u.context,h,d),!0;case 4:return u.fn.call(u.context,h,d,y),!0;case 5:return u.fn.call(u.context,h,d,y,f),!0;case 6:return u.fn.call(u.context,h,d,y,f,p),!0}for(g=1,I=new Array(D-1);g<D;g++)I[g-1]=arguments[g];u.fn.apply(u.context,I)}else{var se=u.length,O;for(g=0;g<se;g++)switch(u[g].once&&this.removeListener(l,u[g].fn,void 0,!0),D){case 1:u[g].fn.call(u[g].context);break;case 2:u[g].fn.call(u[g].context,h);break;case 3:u[g].fn.call(u[g].context,h,d);break;case 4:u[g].fn.call(u[g].context,h,d,y);break;default:if(!I)for(O=1,I=new Array(D-1);O<D;O++)I[O-1]=arguments[O];u[g].fn.apply(u[g].context,I)}}return!0},a.prototype.on=function(l,h,d){return s(this,l,h,d,!1)},a.prototype.once=function(l,h,d){return s(this,l,h,d,!0)},a.prototype.removeListener=function(l,h,d,y){var f=n?n+l:l;if(!this._events[f])return this;if(!h)return o(this,f),this;var p=this._events[f];if(p.fn)p.fn===h&&(!y||p.once)&&(!d||p.context===d)&&o(this,f);else{for(var m=0,u=[],D=p.length;m<D;m++)(p[m].fn!==h||y&&!p[m].once||d&&p[m].context!==d)&&u.push(p[m]);u.length?this._events[f]=u.length===1?u[0]:u:o(this,f)}return this},a.prototype.removeAllListeners=function(l){var h;return l?(h=n?n+l:l,this._events[h]&&o(this,h)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,t.exports=a})(A)),A.exports}var fe=ue();const W=de(fe);function X(t,e,n,r){const i=n+r.rowGap,s=n+r.columnGap;return[(c,l)=>!(r.rowGap>0&&(e+l)%i>=n||r.columnGap>0&&(t+c)%s>=n),c=>!(r.rowGap>0&&(e+c)%i>=n)]}function pe(t,e,n,r,i,s,o,a,c){const l=i*s;if(t.length!==l*n.length)throw new Error(`Incorrect buffer length ${t.length} expected ${l*n.length}`);if(e.length!==l*2+r)throw new Error(`Incorrect buffer length ${e.length} expected ${l*2+r}`);const h=S(t),d=S(e);switch(n){case _.RGB:for(let y=0;y<s;y++)if(a(y))for(let f=0;f<i;f++){if(!o(f,y))continue;const p=y*i+f,m=h.getUint8(p*3+0)>>3,u=h.getUint8(p*3+1)>>2,D=h.getUint8(p*3+2)>>3;d.setUint16(r+p*2,(m<<11)+(u<<5)+D,c!=="BE")}break;default:throw new Error(`Unknown BufferFormat: "${n}"`)}}function T(t){if(t<0||t>255)throw new TypeError("Expected a valid color RGB value 0 - 255")}function ye(t){T(t.red),T(t.green),T(t.blue)}function S(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function we(t){if(t.length>255){const e=new Uint8Array(14),n=S(e);return n.setUint8(0,130),n.setUint8(1,255),n.setUint32(6,t.length,!1),e}else{const e=new Uint8Array(6),n=S(e);return n.setUint8(0,130),n.setUint8(1,128+t.length),e}}class te extends Error{constructor(e){super(e),this.name="TimeoutError"}}class ge extends Error{constructor(e){super(),this.name="AbortError",this.message=e}}const Y=t=>globalThis.DOMException===void 0?new ge(t):new DOMException(t),Q=t=>{const e=t.reason===void 0?Y("This operation was aborted."):t.reason;return e instanceof Error?e:Y(e)};function me(t,e){const{milliseconds:n,fallback:r,message:i,customTimers:s={setTimeout,clearTimeout}}=e;let o,a;const l=new Promise((h,d)=>{if(typeof n!="number"||Math.sign(n)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(e.signal){const{signal:f}=e;f.aborted&&d(Q(f)),a=()=>{d(Q(f))},f.addEventListener("abort",a,{once:!0})}if(n===Number.POSITIVE_INFINITY){t.then(h,d);return}const y=new te;o=s.setTimeout.call(void 0,()=>{if(r){try{h(r())}catch(f){d(f)}return}typeof t.cancel=="function"&&t.cancel(),i===!1?h():i instanceof Error?d(i):(y.message=i??`Promise timed out after ${n} milliseconds`,d(y))},n),(async()=>{try{h(await t)}catch(f){d(f)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{s.clearTimeout.call(void 0,o),o=void 0},l}function Se(t,e,n){let r=0,i=t.length;for(;i>0;){const s=Math.trunc(i/2);let o=r+s;n(t[o],e)<=0?(r=++o,i-=s+1):i=s}return r}class Ee{#e=[];enqueue(e,n){n={priority:0,...n};const r={priority:n.priority,id:n.id,run:e};if(this.size===0||this.#e[this.size-1].priority>=n.priority){this.#e.push(r);return}const i=Se(this.#e,r,(s,o)=>o.priority-s.priority);this.#e.splice(i,0,r)}setPriority(e,n){const r=this.#e.findIndex(s=>s.id===e);if(r===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[i]=this.#e.splice(r,1);this.enqueue(i.run,{priority:n,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(n=>n.priority===e.priority).map(n=>n.run)}get size(){return this.#e.length}}class ve extends W{#e;#i;#o=0;#a;#l;#h=0;#r;#d;#n;#f;#s=0;#c;#t;#u;#p=1n;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Ee,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#i=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#a=e.intervalCap,this.#l=e.interval,this.#n=new e.queueClass,this.#f=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#u=e.throwOnTimeout===!0,this.#t=e.autoStart===!1}get#y(){return this.#i||this.#o<this.#a}get#v(){return this.#s<this.#c}#x(){this.#s--,this.#w(),this.emit("next")}#R(){this.#E(),this.#S(),this.#d=void 0}get#D(){const e=Date.now();if(this.#r===void 0){const n=this.#h-e;if(n<0)this.#o=this.#e?this.#s:0;else return this.#d===void 0&&(this.#d=setTimeout(()=>{this.#R()},n)),!0}return!1}#w(){if(this.#n.size===0)return this.#r&&clearInterval(this.#r),this.#r=void 0,this.emit("empty"),this.#s===0&&this.emit("idle"),!1;if(!this.#t){const e=!this.#D;if(this.#y&&this.#v){const n=this.#n.dequeue();return n?(this.emit("active"),n(),e&&this.#S(),!0):!1}}return!1}#S(){this.#i||this.#r!==void 0||(this.#r=setInterval(()=>{this.#E()},this.#l),this.#h=Date.now()+this.#l)}#E(){this.#o===0&&this.#s===0&&this.#r&&(clearInterval(this.#r),this.#r=void 0),this.#o=this.#e?this.#s:0,this.#g()}#g(){for(;this.#w(););}get concurrency(){return this.#c}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#c=e,this.#g()}async#b(e){return new Promise((n,r)=>{e.addEventListener("abort",()=>{r(e.reason)},{once:!0})})}setPriority(e,n){this.#n.setPriority(e,n)}async add(e,n={}){return n.id??=(this.#p++).toString(),n={timeout:this.timeout,throwOnTimeout:this.#u,...n},new Promise((r,i)=>{this.#n.enqueue(async()=>{this.#s++;try{n.signal?.throwIfAborted(),this.#o++;let s=e({signal:n.signal});n.timeout&&(s=me(Promise.resolve(s),{milliseconds:n.timeout})),n.signal&&(s=Promise.race([s,this.#b(n.signal)]));const o=await s;r(o),this.emit("completed",o)}catch(s){if(s instanceof te&&!n.throwOnTimeout){r();return}i(s),this.emit("error",s)}finally{this.#x()}},n),this.emit("add"),this.#w()})}async addAll(e,n){return Promise.all(e.map(async r=>this.add(r,n)))}start(){return this.#t?(this.#t=!1,this.#g(),this):this}pause(){this.#t=!0}clear(){this.#n=new this.#f}async onEmpty(){this.#n.size!==0&&await this.#m("empty")}async onSizeLessThan(e){this.#n.size<e||await this.#m("next",()=>this.#n.size<e)}async onIdle(){this.#s===0&&this.#n.size===0||await this.#m("idle")}async#m(e,n){return new Promise(r=>{const i=()=>{n&&!n()||(this.off(e,i),r())};this.on(e,i)})}get size(){return this.#n.size}sizeBy(e){return this.#n.filter(e).length}get pending(){return this.#s}get isPaused(){return this.#t}}var x;(function(t){t[t.SetColour=2]="SetColour",t[t.GetSerialNumber=3]="GetSerialNumber",t[t.GetVersion=7]="GetVersion",t[t.SetBrightness=9]="SetBrightness",t[t.RefreshDisplay=15]="RefreshDisplay",t[t.DrawFramebuffer=16]="DrawFramebuffer",t[t.SetVibration=27]="SetVibration"})(x||(x={}));class L extends W{#e={};#i;options;modelSpec;get controls(){return this.modelSpec.controls}get displayMain(){return this.modelSpec.displayMain}get displayLeftStrip(){return this.modelSpec.displayLeftStrip}get displayRightStrip(){return this.modelSpec.displayRightStrip}get displayWheel(){return this.modelSpec.displayWheel}#o={};#a=0;#l;constructor(e,n,r){super(),this.#i=e,this.options={...n},this.modelSpec=r,this.options.skipWaitForAcks||(this.#l=new ve({concurrency:1})),this.#i.on("error",i=>{this.#r(),this.emit("error",i)}),this.#i.on("disconnect",()=>{this.#r(),this.emit("error",new Error("Connection lost"))}),this.#i.on("message",this.#d.bind(this))}get modelId(){return this.modelSpec.modelId}get modelName(){return this.modelSpec.modelName}get lcdKeyColumns(){return this.modelSpec.lcdKeyColumns}get lcdKeyRows(){return this.modelSpec.lcdKeyRows}get lcdKeySize(){return this.modelSpec.lcdKeySize}#h(e){switch(e){case w.Center:return this.displayMain;case w.Left:return this.displayLeftStrip;case w.Right:return this.displayRightStrip;case w.Wheel:return this.displayWheel;default:return}}async blankDevice(e=!0,n=!0){await this.#c(async()=>{if(e)for(const r of Object.values(w)){const i=this.#h(r);if(i){const{encoded:s,encodedDisplay:o}=this.createBufferWithHeader(r,i.width+i.xPadding*2,i.height+i.yPadding*2,0,0);await this.#t(x.DrawFramebuffer,s,!0),this.modelSpec.framebufferFlush&&await this.#t(x.RefreshDisplay,o,!0)}}if(n){const r=this.controls.filter(o=>o.type===v.Button),i=new Uint8Array(4*r.length),s=S(i);for(let o=0;o<r.length;o++)s.setUint8(o*4,r[o].encoded);await this.#t(x.SetColour,i,!0)}},!1)}#r(){setTimeout(()=>{for(const e of Object.values(this.#o))e.reject(new Error("Connection closed"))},0)}async close(){this.#r(),await this.#i.close()}convertKeyIndexToCoordinates(e,n){const r=this.lcdKeyColumns,i=this.lcdKeySize+(n.columnGap??0),s=this.lcdKeySize+(n.rowGap??0),o=e%r*i,a=Math.floor(e/r)*s;return[o,a]}createBufferWithHeader(e,n,r,i,s){if(!this.modelSpec.splitTopDisplays&&!(e===w.Left||e===w.Wheel))if(e===w.Center)i+=this.displayLeftStrip?.width??0;else if(e===w.Right)i+=(this.displayLeftStrip?.width??0)+(this.displayMain.width+this.displayMain.xPadding*2);else throw new Error("Unknown DisplayId");const o=10,a=n*r,c=new Uint8Array(a*2+o),l=S(c);let h=oe;if(e===w.Wheel)h=ae;else if(this.modelSpec.splitTopDisplays)switch(e){case w.Center:h=le;break;case w.Left:h=ce;break;case w.Right:h=he;break;default:throw new Error("Unknown DisplayId")}return c.set(h,0),l.setUint16(2,i,!1),l.setUint16(4,s,!1),l.setUint16(6,n,!1),l.setUint16(8,r,!1),{encoded:c,padding:o,encodedDisplay:h}}async drawBuffer(e,n,r,i,s,o,a){const c=this.#h(e);if(!c)throw new Error("Invalid DisplayId");if(i<0||i>c.width)throw new Error("Image width is not valid");if(s<0||s>c.height)throw new Error("Image width is not valid");if(o<0||o+i>c.width)throw new Error("x is not valid");if(a<0||a+s>c.height)throw new Error("x is not valid");const{encoded:l,padding:h,encodedDisplay:d}=this.createBufferWithHeader(e,i,s,o+c.xPadding,a+c.yPadding),[y,f]=X(o,a,this.lcdKeySize,c);pe(n,l,r,h,i,s,y,f,c.endianness),await this.#c(async()=>{await this.#t(x.DrawFramebuffer,l,!0),this.modelSpec.framebufferFlush&&await this.#t(x.RefreshDisplay,d,!0)},!1)}async drawKeyBuffer(e,n,r){const[i,s]=this.convertKeyIndexToCoordinates(e,this.displayMain),o=this.lcdKeySize;return this.drawBuffer(w.Center,n,r,o,o,i,s)}async drawSolidColour(e,n,r,i,s,o){const a=this.#h(e);if(!a)throw new Error("Invalid DisplayId");if(r<0||r>a.width)throw new Error("Image width is not valid");if(i<0||i>a.height)throw new Error("Image height is not valid");if(s<0||s+r>a.width)throw new Error("x is not valid");if(o<0||o+i>a.height)throw new Error("y is not valid");ye(n);const c=((Math.round(n.red)>>3&31)<<11)+((Math.round(n.green)>>2&63)<<5)+(Math.round(n.blue)>>3&31),[l,h]=X(s,o,this.lcdKeySize,a),{encoded:d,padding:y,encodedDisplay:f}=this.createBufferWithHeader(e,r,i,s+a.xPadding,o),p=S(d);for(let m=0;m<i;m++)if(h(m)){for(let u=0;u<r;u++)if(l(u,m)){const D=m*r+u;p.setUint16(D*2+y,c,a.endianness!=="BE")}}await this.#c(async()=>{await this.#t(x.DrawFramebuffer,d,!0),this.modelSpec.framebufferFlush&&await this.#t(x.RefreshDisplay,f,!0)},!1)}async getFirmwareVersion(){const e=await this.#u(x.GetVersion,void 0),n=S(e);return`${n.getUint8(0)}.${n.getUint8(1)}.${n.getUint8(2)}`}async getSerialNumber(){return(await this.#u(x.GetSerialNumber,void 0)).toString().trim()}#d(e){try{const n=S(e);if(n.getUint8(2)+2!==e.length)return;const i=n.getUint8(3),s=n.getUint8(4);if(s===0)switch(i){case 0:this.#n(e.subarray(5));break;case 1:this.#f(e.subarray(5));break;case 77:this.onTouch("touchmove",e.subarray(5));break;case 109:this.onTouch("touchend",e.subarray(5));break;case 82:this.onWheelTouch("touchmove",e.subarray(5));break;case 114:this.onWheelTouch("touchend",e.subarray(5));break;default:console.warn("unhandled incoming message",e);break}else{const o=this.#o[s];o&&(o.resolve(e.subarray(5)),delete this.#o[s])}}catch(n){console.error("Unhandled error in serial message handler:",n)}}#n(e){const n=S(e),r=n.getUint8(0),i=this.controls.find(s=>s.encoded===r);if(i){const s=n.getUint8(1)===0?"down":"up";this.emit(s,{type:i.type,index:i.index})}}#f(e){const n=S(e),r=n.getUint8(0),i=this.controls.find(s=>s.encoded===r);if(i&&i.type===v.Rotary){const s=n.getInt8(1);this.emit("rotate",{type:i.type,index:i.index},s)}}#s(e,n,r,i,s,o){const a={x:n,y:r,id:i,target:{screen:s,key:o}};e==="touchend"?delete this.#e[a.id]:(this.#e[a.id]||(e="touchstart"),this.#e[a.id]=a),this.emit(e,{touches:Object.values(this.#e),changedTouches:[a]})}onTouch(e,n){const r=S(n);let i=r.getUint16(1,!1),s=r.getUint16(3,!1);const o=r.getUint8(5),a=this.displayMain.width+this.displayMain.xPadding*2,c=this.displayLeftStrip?.width??0;let l=w.Center;const h=(this.displayLeftStrip?.width??0)+a;this.displayLeftStrip&&i<c?l=w.Left:this.displayRightStrip&&i>=h?(l=w.Right,i-=h):(i-=c+this.displayMain.xPadding,s-=this.displayMain.yPadding);let d;if(l===w.Center){const y=i+this.displayMain.columnGap/2,f=s+this.displayMain.rowGap/2,p=Math.floor(y/(this.lcdKeySize+this.displayMain.columnGap));d=Math.floor(f/(this.lcdKeySize+this.displayMain.rowGap))*this.lcdKeyColumns+p}this.#s(e,i,s,o,l,d)}onWheelTouch(e,n){const r=S(n),i=r.getUint16(1,!1),s=r.getUint16(3,!1),o=r.getUint8(5),a=w.Wheel;this.#s(e,i,s,o,a,void 0)}async setBrightness(e){const r=Math.max(0,Math.min(10,Math.round(e*10)));return this.#t(x.SetBrightness,new Uint8Array([r]))}async setButtonColor(...e){if(e.length===0)return;const n={};for(const s of this.controls)s.type===v.Button&&(n[s.index]=s.encoded);const r=new Uint8Array(4*e.length),i=S(r);for(let s=0;s<e.length;s++){const o=e[s],a=s*4,c=n[o.id];if(c===void 0)throw new TypeError("Expected a valid button id");T(o.red),T(o.green),T(o.blue),i.setUint8(0+a,c),i.setUint8(1+a,o.red),i.setUint8(2+a,o.green),i.setUint8(3+a,o.blue)}return this.#t(x.SetColour,r)}async vibrate(e){if(!e)throw new Error("Invalid vibrate pattern");return this.#t(x.SetVibration,new Uint8Array([e]))}async#c(e,n){return this.#l&&!n?this.#l.add(e,{throwOnTimeout:!0}):e()}async#t(e,n,r=!1){return this.#c(async()=>{const i=await this.#p(e,n);this.options.skipWaitForAcks||await this.#y(i)},r)}async#u(e,n,r=!1){return this.#c(async()=>{const i=await this.#p(e,n);return this.#y(i)},r)}async#p(e,n){if(!this.#i.isReady())throw new Error("Not connected!");this.#a=(this.#a+1)%256,this.#a===0&&this.#a++;const r=new Uint8Array(3+(n?.length??0)),i=S(r);return i.setUint8(0,r.length>=255?255:r.length),i.setUint8(1,e),i.setUint8(2,this.#a),n&&n.length&&r.set(n,3),await this.#i.send(r),this.#a}async#y(e){if(this.#o[e])throw new Error("Transaction handler already defined");if(!this.#i.isReady())throw new Error("Connection is not open");const n={resolve:()=>null,reject:()=>null},r=new Promise((i,s)=>{n.resolve=i,n.reject=s});return this.#o[e]=n,r}}const xe={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},Re={width:350,height:260,xPadding:5,yPadding:5,columnGap:10,rowGap:10},De={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},$={controls:[],displayMain:Re,displayLeftStrip:xe,displayRightStrip:De,modelId:E.LoupedeckLive,modelName:"Loupedeck Live",lcdKeySize:80,lcdKeyColumns:4,lcdKeyRows:3};for(let t=0;t<8;t++)$.controls.push({type:v.Button,index:t,encoded:7+t});for(let t=0;t<6;t++)$.controls.push({type:v.Rotary,index:t,encoded:1+t});class be extends L{constructor(e,n){super(e,n,$)}}const Ce={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},Ie={width:350,height:260,xPadding:5,yPadding:5,columnGap:10,rowGap:10},_e={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},P={controls:[],displayMain:Ie,displayLeftStrip:Ce,displayRightStrip:_e,modelId:E.RazerStreamController,modelName:"Razer Stream Controller",lcdKeySize:80,lcdKeyColumns:4,lcdKeyRows:3};for(let t=0;t<8;t++)P.controls.push({type:v.Button,index:t,encoded:7+t});for(let t=0;t<6;t++)P.controls.push({type:v.Rotary,index:t,encoded:1+t});class Te extends L{constructor(e,n){super(e,n,P)}}const Le={width:444,height:260,xPadding:18,yPadding:5,columnGap:10,rowGap:10},F={controls:[],displayMain:Le,displayLeftStrip:void 0,displayRightStrip:void 0,modelId:E.LoupedeckLiveS,modelName:"Loupedeck Live S",lcdKeySize:80,lcdKeyColumns:5,lcdKeyRows:3};for(let t=0;t<2;t++)F.controls.push({type:v.Rotary,index:t,encoded:1+t});for(let t=0;t<4;t++)F.controls.push({type:v.Button,index:t,encoded:7+t});class Ue extends L{constructor(e,n){super(e,n,F)}}const Oe={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},Be={width:350,height:260,xPadding:5,yPadding:5,columnGap:10,rowGap:10},Me={width:60,height:270,xPadding:0,yPadding:0,columnGap:0,rowGap:0},Ae={width:240,height:240,xPadding:0,yPadding:0,columnGap:0,rowGap:0,endianness:"BE"},U={controls:[],displayMain:Be,displayLeftStrip:Oe,displayRightStrip:Me,displayWheel:Ae,modelId:E.LoupedeckCt,modelName:"Loupedeck CT",lcdKeySize:80,lcdKeyColumns:4,lcdKeyRows:3};for(let t=0;t<8;t++)U.controls.push({type:v.Button,index:t,encoded:7+t});for(let t=0;t<12;t++)U.controls.push({type:v.Button,index:t+8,encoded:15+t});for(let t=0;t<6;t++)U.controls.push({type:v.Rotary,index:t,encoded:1+t});U.controls.push({type:v.Rotary,index:6,encoded:0});class Ge extends L{constructor(e,n){super(e,n,U)}}const Ne={width:470,height:270,xPadding:5,yPadding:0,columnGap:20,rowGap:18},ne={controls:[],displayMain:Ne,displayLeftStrip:void 0,displayRightStrip:void 0,modelId:E.RazerStreamControllerX,modelName:"Razer Stream Controller X",lcdKeySize:78,lcdKeyColumns:5,lcdKeyRows:3};for(let t=0;t<15;t++)ne.controls.push({type:v.Button,index:t,encoded:27+t});class We extends L{constructor(e,n){super(e,n,ne)}onTouch(e,n){}}const $e={...U,splitTopDisplays:!0,modelId:E.LoupedeckCtV1,framebufferFlush:!0};class Pe extends L{constructor(e,n){super(e,n,$e)}}const z=[{id:E.LoupedeckCtV1,vendorId:M,productId:3,class:Pe},{id:E.LoupedeckCt,vendorId:M,productId:7,class:Ge},{id:E.LoupedeckLive,vendorId:M,productId:4,class:be},{id:E.LoupedeckLiveS,vendorId:M,productId:6,class:Ue},{id:E.RazerStreamController,vendorId:k,productId:3334,class:Te},{id:E.RazerStreamControllerX,vendorId:k,productId:3337,class:We}],Fe=new TextEncoder().encode(`GET /index.html
HTTP/1.1
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Key: 123abc

`),ze="HTTP/1.1";class Ke extends W{}class K extends Ke{connection;reader;writer;isOpen;constructor(e,n,r){super(),this.connection=e,this.reader=n,this.writer=r,this.isOpen=!0,this.connection.addEventListener("error",i=>{this.emit("error",i)}),this.connection.addEventListener("connect",()=>{console.log("connect"),this.isOpen=!0;try{this.openReaderWriter()}catch(i){this.emit("error",i)}}),this.connection.addEventListener("disconnect",()=>{console.log("disconnect"),this.isOpen=!1,this.closeReaderWriter(),this.emit("disconnect")}),this.startReadLoop(this.reader)}startReadLoop(e){Promise.resolve().then(async()=>{const n=new ke({delimiter:130});for(;;){const{value:r,done:i}=await e.read();if(r){const s=n.transform(r);for(const o of s)this.emit("message",o)}if(i){e.releaseLock();break}}}).catch(n=>{this.emit("error",n)})}closeReaderWriter(){this.writer&&(this.writer.close().catch(()=>null),delete this.writer)}openReaderWriter(){if(this.closeReaderWriter(),!this.connection)throw new Error("SerialPort is closed");if(!this.connection.writable)throw new Error("SerialPort is not writable");if(!this.connection.readable)throw new Error("SerialPort is not readable");this.writer=this.connection.writable.getWriter(),this.reader=this.connection.readable.getReader(),this.startReadLoop(this.reader)}static async open(e){let n,r;try{if(await e.open({baudRate:256e3}),!e.writable)throw new Error("SerialPort is not writable");if(!e.readable)throw new Error("SerialPort is not readable");r=e.writable.getWriter(),n=e.readable.getReader();let i=!1;const s=r,[o]=await Promise.all([n.read().then(c=>(i=!0,c)),new Promise((c,l)=>{setTimeout(()=>{l(new Error("Timed out"))},5e3);const h=()=>{i?c():s.write(Fe).then(()=>{setTimeout(h,10)}).catch(d=>{l(d instanceof Error?d:new Error(String(d)))})};h()})]).catch(c=>{throw i=!0,n?.cancel("Aborted").catch(()=>null),c});if(!o.value)throw new Error("No handshake response");const a=o.value;if(!a.toString().startsWith(ze))throw new Error(`Invalid handshake response: ${a.toString()}`);return new K(e,n,r)}catch(i){throw e.close().catch(()=>null),n?.cancel("Aborted")?.catch(()=>null),r?.abort("Aborted")?.catch(()=>null),i}}async close(){this.writer&&(this.writer.close().catch(()=>null),delete this.writer),this.connection&&(await this.connection.close().catch(()=>null),delete this.connection)}isReady(){return this.connection!==void 0&&this.isOpen}async send(e,n=!1){if(!this.connection||!this.writer)throw new Error("Not connected!");if(!n){const r=we(e);await this.writer.write(r)}await this.writer.write(e)}}class ke{buffer=new Uint8Array(0);start=!0;opts;constructor(e={}){const{delimiter:n=170,packetOverhead:r=2,lengthOffset:i=1,maxLen:s=255}=e;this.opts={delimiter:n,packetOverhead:r,lengthOffset:i,maxLen:s}}transform(e){const n=[];for(let r=0;r<e.length;r++){const i=e[r];if(i===this.opts.delimiter&&(this.start=!0),this.start===!0){const s=this.buffer;this.buffer=new Uint8Array(s.length+1);const o=S(this.buffer);if(this.buffer.set(s,0),this.buffer[this.buffer.length-1]=i,this.buffer.length>=this.opts.lengthOffset+1){const a=o.getUint8(this.opts.lengthOffset);(this.buffer.length==a+this.opts.packetOverhead||a>this.opts.maxLen)&&(n.push(this.buffer),this.buffer=new Uint8Array(0),this.start=!1)}}}return n}}const qe=z.map(t=>({usbProductId:t.productId,usbVendorId:t.vendorId}));async function He(t){const e=await navigator.serial.requestPort({filters:qe});return re(e)}async function Xe(t){const e=await navigator.serial.getPorts();if(e.length===0)return[];const n=new Set;for(const s of z)n.add(`${s.vendorId}-${s.productId}`);const r=e.filter(s=>{const o=s.getInfo();return n.has(`${o.usbVendorId}-${o.usbProductId}`)});return(await Promise.all(r.map(async s=>re(s).catch(o=>null)))).filter(s=>!!s)}async function re(t,e){const n=t.getInfo(),r=z.find(a=>a.productId===n.usbProductId&&a.vendorId===n.usbVendorId);if(!r)throw new Error("Stream Deck is of unexpected type.");const i=await K.open(t),s={};return new r.class(i,s||{})}function V(t){return`${t.type}-${t.index}`}const Ye={red:255,green:0,blue:0},Qe={red:0,green:0,blue:0},Z=new Uint8Array(6400*3),N=new Uint8Array(6400*3);for(let t=0;t<6400;t++)N.set([255,0,0],t*3);class ie{pressed=[];touchBoxes=new Set;touchingLeft=!1;touchingRight=!1;async start(e){await e.blankDevice(!0,!1)}async stop(e){await e.blankDevice(!0,!1)}async controlDown(e,n){const r=V(n);this.pressed.indexOf(r)===-1&&(this.pressed.push(r),e.modelId===E.RazerStreamControllerX?await e.drawKeyBuffer(n.index,N,_.RGB):await e.setButtonColor({id:n.index,...Ye}))}async controlUp(e,n){const r=V(n),i=this.pressed.indexOf(r);i!==-1&&(this.pressed.splice(i,1),e.modelId===E.RazerStreamControllerX?await e.drawKeyBuffer(n.index,Z,_.RGB):await e.setButtonColor({id:n.index,...Qe}))}async controlRotate(e,n,r){}async touchStart(e,n){return this.touchMove(e,n)}async touchMove(e,n){const r=[],i=new Set;let s=0,o=0;for(const a of n.touches)if(a.target.screen===w.Center&&a.target.key!==void 0)i.add(a.target.key),this.touchBoxes.has(a.target.key)||(this.touchBoxes.add(a.target.key),r.push(e.drawKeyBuffer(a.target.key,N,_.RGB)));else if(a.target.screen===w.Left&&e.displayLeftStrip){const c=a.y/e.displayLeftStrip.height;s=Math.max(s,c)}else if(a.target.screen===w.Right&&e.displayRightStrip){const c=a.y/e.displayRightStrip.height;o=Math.max(o,c)}for(const a of this.touchBoxes)i.has(a)||(this.touchBoxes.delete(a),r.push(e.drawKeyBuffer(a,Z,_.RGB)));e.displayLeftStrip&&(s>0||this.touchingLeft)&&(this.touchingLeft=s>0,r.push(e.drawSolidColour(w.Left,{red:Math.round(255*s),green:0,blue:0},e.displayLeftStrip.width,e.displayLeftStrip.height,0,0))),e.displayRightStrip&&(o>0||this.touchingRight)&&(this.touchingRight=o>0,r.push(e.drawSolidColour(w.Right,{red:Math.round(255*o),green:0,blue:0},e.displayRightStrip.width,e.displayRightStrip.height,0,0))),await Promise.allSettled(r)}async touchEnd(e,n){return this.touchMove(e,n)}}function G(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}class Ve{interval;running;async start(e){if(!this.interval){const n=async()=>{if(!this.running){const r={red:G(0,255),green:G(0,255),blue:G(0,255)};console.log("Filling with rgb(%d, %d, %d)",r.red,r.green,r.blue),this.running=Promise.all([e.drawSolidColour(w.Center,r,e.displayMain.width,e.displayMain.height,0,0),e.displayLeftStrip?e.drawSolidColour(w.Left,r,e.displayLeftStrip.width,e.displayLeftStrip.height,0,0):void 0,e.displayRightStrip?e.drawSolidColour(w.Right,r,e.displayRightStrip.width,e.displayRightStrip.height,0,0):void 0]);try{await this.running}finally{this.running=void 0}}};this.interval=window.setInterval(()=>{n().catch(r=>console.log(r))},1e3/5)}}async stop(e){this.interval&&(window.clearInterval(this.interval),this.interval=void 0),await this.running,await e.blankDevice(!0,!0)}async controlDown(e,n){}async controlUp(e,n){}async controlRotate(e,n,r){}async touchStart(e,n){}async touchMove(e,n){}async touchEnd(e,n){}}function b(t){const e=document.getElementById("log");e&&(e.textContent=`${t}
${e.textContent??""}`)}const B=document.getElementById("demo-select"),j=document.getElementById("consent-button");let R=null,C=new ie;async function J(){if(B){switch(console.log(`Selected demo: ${B.value}`),R&&await C.stop(R),B.value){case"rapid-fill":C=new Ve;break;case"fill-when-pressed":default:C=new ie;break}R&&await C.start(R)}}async function ee(t){b("Device opened"),b(`Serial: ${await t.getSerialNumber()} Firmware: ${await t.getFirmwareVersion()}`),t.on("error",e=>{b(`Error: ${e}`)}),t.on("down",e=>{b(`${e.type}-${e.index} down`),C.controlDown(t,e).catch(console.error)}),t.on("up",e=>{b(`${e.type}-${e.index} up`),C.controlUp(t,e).catch(console.error)}),t.on("rotate",(e,n)=>{b(`${e.type}-${e.index} rotate ${n}`),C.controlRotate(t,e,n).catch(console.error)}),t.on("touchstart",e=>{b(`Touch start ${JSON.stringify(e)}`),C.touchStart(t,e).catch(console.error)}),t.on("touchmove",e=>{b(`Touch move ${JSON.stringify(e)}`),C.touchMove(t,e).catch(console.error)}),t.on("touchend",e=>{b(`Touch end ${JSON.stringify(e)}`),C.touchEnd(t,e).catch(console.error)}),await C.start(t),await t.setBrightness(70)}if(j){const t=async()=>{const r=await Xe();r.length>0&&(R=r[0],ee(R).catch(console.error)),console.log(r)};window.addEventListener("load",()=>{t().catch(r=>console.error(r))});const e=document.getElementById("brightness-range");e&&e.addEventListener("input",r=>{const i=e.value;R&&R.setBrightness(i/100).catch(console.error)}),B&&(B.addEventListener("input",()=>{J().catch(console.error)}),J().catch(console.error));const n=async()=>{R&&(b("Closing device"),C.stop(R).catch(console.error),await R.close(),R=null);try{R=await He()}catch(r){b(`No device access granted: ${r}`);return}ee(R).catch(console.error)};j.addEventListener("click",()=>{n().catch(r=>console.error(r))}),b("Page loaded")}
